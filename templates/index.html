<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Downloader</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        input[type="text"], select {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 0;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .video-info {
            display: flex;
            margin-bottom: 15px;
        }
        .thumbnail {
            width: 120px;
            height: 90px;
            object-fit: cover;
            margin-right: 15px;
        }
        .formats {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .formats th, .formats td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .formats tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .formats th {
            background-color: #4285f4;
            color: white;
        }
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .hidden {
            display: none;
        }
        .tabs {
            display: flex;
            margin-bottom: 15px;
        }
        .tab {
            padding: 10px 15px;
            background-color: #e9e9e9;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background-color: #4285f4;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>YouTube Downloader</h1>
        
        <div id="cookie-status" class="message warning">
            Vérification des cookies...
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="downloader">Téléchargeur</div>
            <div class="tab" data-tab="cookies">Gestion des cookies</div>
        </div>
        
        <div id="downloader-tab" class="tab-content active">
            <div class="card">
                <h2>Entrer l'URL de la vidéo</h2>
                <input type="text" id="video-url" placeholder="https://www.youtube.com/watch?v=...">
                <button onclick="getVideoInfo()">Obtenir les informations</button>
            </div>
            
            <div id="video-details" class="card hidden">
                <div class="video-info">
                    <img id="video-thumbnail" class="thumbnail" src="" alt="Miniature">
                    <div>
                        <h3 id="video-title"></h3>
                        <p>Durée: <span id="video-duration"></span> secondes</p>
                    </div>
                </div>
                
                <h3>Formats disponibles</h3>
                <table class="formats">
                    <thead>
                        <tr>
                            <th>Format</th>
                            <th>Résolution</th>
                            <th>Extension</th>
                            <th>Taille</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="formats-list">
                        <!-- Les formats seront ajoutés ici -->
                    </tbody>
                </table>
            </div>
            
            <div id="message" class="hidden message"></div>
        </div>
        
        <div id="cookies-tab" class="tab-content">
            <div class="card">
                <h2>Téléverser un fichier de cookies</h2>
                <p>Pour télécharger des vidéos restreintes, vous devez fournir un fichier de cookies valide.</p>
                
                <form id="cookie-form" enctype="multipart/form-data">
                    <input type="file" id="cookie-file" accept=".txt">
                    <button type="submit">Téléverser</button>
                </form>
                
                <div id="cookie-message" class="hidden message"></div>
                
                <p style="margin-top: 20px;">
                    <a href="/cookies-help">Comment obtenir un fichier de cookies ?</a>
                </p>
            </div>
        </div>
    </div>

    <script>
        // Vérifier le statut des cookies au chargement
        window.onload = function() {
            checkCookieStatus();
            
            // Configuration des onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
                });
            });
            
            // Configuration du formulaire de cookies
            document.getElementById('cookie-form').addEventListener('submit', function(e) {
                e.preventDefault();
                uploadCookies();
            });
        };
        
        // Vérifier si les cookies sont disponibles
        function checkCookieStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    const statusDiv = document.getElementById('cookie-status');
                    
                    if (data.cookies_found) {
                        statusDiv.className = 'message success';
                        statusDiv.textContent = data.message;
                    } else {
                        statusDiv.className = 'message warning';
                        statusDiv.textContent = 'Aucun fichier de cookies trouvé. Certaines vidéos restreintes pourraient ne pas être accessibles.';
                    }
                })
                .catch(error => {
                    document.getElementById('cookie-status').className = 'message error';
                    document.getElementById('cookie-status').textContent = 'Erreur lors de la vérification des cookies: ' + error;
                });
        }
        
        // Téléverser un fichier de cookies
        function uploadCookies() {
            const fileInput = document.getElementById('cookie-file');
            const messageDiv = document.getElementById('cookie-message');
            
            if (!fileInput.files[0]) {
                messageDiv.className = 'message error';
                messageDiv.textContent = 'Veuillez sélectionner un fichier';
                messageDiv.classList.remove('hidden');
                return;
            }
            
            const formData = new FormData();
            formData.append('cookies', fileInput.files[0]);
            
            fetch('/upload-cookies', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    messageDiv.className = 'message success';
                    messageDiv.textContent = data.message;
                    // Mettre à jour le statut des cookies
                    checkCookieStatus();
                } else {
                    messageDiv.className = 'message error';
                    messageDiv.textContent = data.error;
                }
                messageDiv.classList.remove('hidden');
            })
            .catch(error => {
                messageDiv.className = 'message error';
                messageDiv.textContent = 'Erreur: ' + error;
                messageDiv.classList.remove('hidden');
            });
        }
        
        // Obtenir les informations de la vidéo
        function getVideoInfo() {
            const url = document.getElementById('video-url').value;
            const messageDiv = document.getElementById('message');
            
            if (!url) {
                messageDiv.className = 'message error';
                messageDiv.textContent = 'Veuillez entrer une URL';
                messageDiv.classList.remove('hidden');
                return;
            }
            
            messageDiv.className = 'message';
            messageDiv.textContent = 'Chargement des informations...';
            messageDiv.classList.remove('hidden');
            
            fetch('/info', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    messageDiv.className = 'message error';
                    messageDiv.textContent = 'Erreur: ' + data.error;
                    return;
                }
                
                // Afficher les détails de la vidéo
                document.getElementById('video-title').textContent = data.title;
                document.getElementById('video-thumbnail').src = data.thumbnail;
                document.getElementById('video-duration').textContent = data.duration;
                
                // Afficher les formats disponibles
                const formatsList = document.getElementById('formats-list');
                formatsList.innerHTML = '';
                
                data.formats.forEach(format => {
                    const row = document.createElement('tr');
                    
                    // Format
                    const formatCell = document.createElement('td');
                    formatCell.textContent = format.format_note || format.format_id;
                    row.appendChild(formatCell);
                    
                    // Résolution
                    const resolutionCell = document.createElement('td');
                    resolutionCell.textContent = format.resolution || 'N/A';
                    row.appendChild(resolutionCell);
                    
                    // Extension
                    const extCell = document.createElement('td');
                    extCell.textContent = format.ext;
                    row.appendChild(extCell);
                    
                    // Taille
                    const sizeCell = document.createElement('td');
                    sizeCell.textContent = format.filesize ? (format.filesize / 1024 / 1024).toFixed(2) + ' MB' : 'N/A';
                    row.appendChild(sizeCell);
                    
                    // Action
                    const actionCell = document.createElement('td');
                    const downloadBtn = document.createElement('button');
                    downloadBtn.textContent = 'Télécharger';
                    downloadBtn.onclick = function() {
                        downloadVideo(url, format.format_id);
                    };
                    actionCell.appendChild(downloadBtn);
                    row.appendChild(actionCell);
                    
                    formatsList.appendChild(row);
                });
                
                // Afficher la section des détails
                document.getElementById('video-details').classList.remove('hidden');
                messageDiv.classList.add('hidden');
            })
            .catch(error => {
                messageDiv.className = 'message error';
                messageDiv.textContent = 'Erreur: ' + error;
            });
        }
        
        // Télécharger la vidéo
        function downloadVideo(url, formatId) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = 'message';
            messageDiv.textContent = 'Préparation du téléchargement...';
            messageDiv.classList.remove('hidden');
            
            fetch('/download', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url, format_id: formatId })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Erreur lors du téléchargement');
                    });
                }
                
                // Créer un lien de téléchargement et cliquer dessus
                const filename = response.headers.get('content-disposition')
                    ? response.headers.get('content-disposition').split('filename=')[1].replace(/"/g, '')
                    : 'video.mp4';
                
                return response.blob().then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                    messageDiv.className = 'message success';
                    messageDiv.textContent = 'Téléchargement réussi!';
                });
            })
            .catch(error => {
                messageDiv.className = 'message error';
                messageDiv.textContent = 'Erreur: ' + error;
            });
        }
    </script>
</body>
</html>
